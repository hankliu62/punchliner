# 段子乐 (Punchliner) - Product Spec

## 1. 产品概述

### 1.1 产品定位
一个段子分享 + AI 增强工具，用户可以浏览段子、使用 AI 续写/改写/吐槽/生成图片，并将段子一键生成朋友圈素材。

### 1.2 目标用户
- **主要用户**：打发时间的摸鱼党、想发朋友圈但不知道发什么的用户
- **使用场景**：
  1. 上班摸鱼时刷段子消遣
  2. 看到有趣段子想收藏以后看
  3. 看到好段子想生成图片分享到朋友圈
  4. 想让 AI 续写或改写段子
  5. 想找相似风格的段子

### 1.3 核心价值
- 每日一乐：首屏展示随机段子，不用点击就能笑
- AI 增强：续写、改写、吐槽、生成图片/视频、朋友圈一键生成
- 零门槛分享：生成可直接发朋友圈的图片/文案

---

## 2. 功能需求

### 2.1 核心功能列表

#### 功能1：每日一乐卡片
- **描述**：首页顶部展示一个随机段子，带"换一个"按钮
- **输入**：无（调用随机段子 API）
- **输出**：显示一条随机段子内容和更新时间
- **缓存机制**：点击"换一个"需间隔 2 秒后才能再次请求（请求队列限制）

#### 功能2：段子列表页
- **描述**：无限滚动 + 虚拟列表加载更多段子
- **输入**：无（分页请求段子列表 API）
- **输出**：段子内容列表，每条显示内容和更新时间
- **虚拟列表**：使用 react-virtualized 或 @tanstack/virtual 实现

#### 功能3：段子详情页
- **描述**：点击段子卡片进入详情页，展示原段子内容和 AI 功能区
- **输入**：段子 ID
- **输出**：段子详情 + AI 功能按钮 + AI 生成结果展示区

#### 功能4：收藏功能
- **描述**：用户可以收藏感兴趣的段子
- **输入**：点击收藏按钮
- **输出**：段子存入 localStorage，收藏列表支持查看
- **存储结构**：`{ id: string, content: string, updateTime: string, collectTime: string }[]`

#### 功能5：点赞功能（虚假）
- **描述**：显示点赞数但不可点击，仅作展示
- **输入**：无
- **输出**：随机生成点赞数展示

### 2.2 AI 增强功能

#### AI 增强点1：AI 续写段子
- **原始功能**：段子详情页
- **AI 增强方式**：根据原段子内容，让 AI 续写后续情节
- **使用场景**：用户看得意犹未尽，想看后续
- **调用接口**：智谱 AI (glm-4-flash) 文本生成 API

#### AI 增强点2：AI 改写风格
- **原始功能**：段子详情页
- **AI 增强方式**：将段子改写成指定风格（冷幽默、黑色幽默、沙雕风、文艺复兴风）
- **使用场景**：用户想看不同风格的版本
- **调用接口**：智谱 AI (glm-4-flash) 文本生成 API

#### AI 增强点3：AI 点评/吐槽
- **原始功能**：段子详情页
- **AI 增强方式**：AI 对段子进行毒舌点评或吐槽
- **使用场景**：用户想看 AI 对段子的看法
- **调用接口**：智谱 AI (glm-4-flash) 文本生成 API

#### AI 增强点4：AI 推荐相似段子
- **原始功能**：段子详情页
- **AI 增强方式**：根据当前段子风格，推荐 3-5 条相似段子
- **使用场景**：用户看完了想看更多同类型
- **调用接口**：智谱 AI (glm-4-flash) 文本生成 API

#### AI 增强点5：AI 生成段子图片
- **原始功能**：段子详情页
- **AI 增强方式**：根据段子内容生成配图，生成可直接分享的图片
- **使用场景**：用户想把段子分享到朋友圈
- **调用接口**：智谱 AI (cogview-3) 图像生成 API

#### AI 增强点6：AI 生成朋友圈内容
- **原始功能**：段子详情页
- **AI 增强方式**：生成适合发朋友圈的文案 + 配图，一键预览朋友圈效果
- **使用场景**：用户想发朋友圈但不知道怎么配文
- **调用接口**：智谱 AI (glm-4-flash) 文本生成 + (cogview-3) 图像生成

#### AI 增强点7：AI 生成小动画视频
- **原始功能**：段子详情页
- **AI 增强方式**：生成 5-10 秒的动画小视频（如果可行）
- **使用场景**：用户想分享短视频到朋友圈/抖音
- **调用接口**：智谱 AI (可控图像生成 + 视频合成能力)

---

## 3. 用户流程

### 3.1 主要用户流程

**流程名称**：浏览段子并使用 AI 增强

1. **打开首页**
   - 用户操作：打开应用
   - 系统响应：展示每日一乐卡片 + 段子列表
   - 界面状态：顶部大卡片显示随机段子，下面虚拟列表显示更多

2. **换一个每日一乐**
   - 用户操作：点击"换一个"按钮
   - 系统响应：检查请求队列，上次请求是否已过 2 秒
   - 界面状态：按钮显示loading，成功后更新卡片内容

3. **浏览更多段子**
   - 用户操作：向下滚动列表
   - 系统响应：触发虚拟列表，加载更多段子
   - 界面状态：列表继续展示新加载的段子

4. **进入详情页**
   - 用户操作：点击任意段子卡片
   - 系统响应：跳转到详情页
   - 界面状态：显示原段子内容 + AI 功能按钮区

5. **使用 AI 功能**
   - 用户操作：点击某个 AI 功能按钮（如"续写"、"改写"等）
   - 系统响应：调用智谱 AI API，生成结果
   - 界面状态：生成中显示 loading，完成后显示在中间区域

6. **生成朋友圈素材**
   - 用户操作：点击"朋友圈"按钮
   - 系统响应：调用 AI 生成文案 + 图片
   - 界面状态：显示完整朋友圈预览（头像+昵称+文案+图片+时间+点赞区+评论区）

7. **保存/复制**
   - 用户操作：点击"复制文案"或"下载图片"
   - 系统响应：复制到剪贴板或下载图片文件
   - 界面状态：显示 toast 提示成功

### 3.2 异常流程

**异常情况1**：API 请求失败
- **触发条件**：网络异常或 API 服务不可用
- **处理方式**：显示错误提示，提供"重试"按钮

**异常情况2**：AI 生成失败
- **触发条件**：智谱 AI API 返回错误
- **处理方式**：显示"生成失败，请重试"提示

**异常情况3**：请求频率超限
- **触发条件**：用户快速连续点击"换一个"
- **处理方式**：按钮倒计时显示剩余时间，倒计时结束后才能继续

**异常情况4**：localStorage 满了
- **触发条件**：收藏过多段子
- **处理方式**：提示"存储空间不足，请删除一些收藏"

---

## 4. UI/UX 设计

### 4.1 整体布局

**布局类型**：单栏布局（移动端优先适配）

**布局结构**：
```
┌─────────────────────────────────────┐
│            Header (导航栏)           │
│  ← 返回              收藏  分享      │
├─────────────────────────────────────┤
│                                     │
│      【每日一乐卡片 - 仅首页】       │
│      段子内容 + 更新时间 + 换一个    │
│      查看更多 →                      │
│                                     │
├─────────────────────────────────────┤
│                                     │
│      【段子列表 - 虚拟列表】        │
│      ┌─────────────────────────┐   │
│      │ 段子卡片 N               │   │
│      └─────────────────────────┘   │
│      ┌─────────────────────────┐   │
│      │ 段子卡片 N+1             │   │
│      └─────────────────────────┘   │
│                                     │
├─────────────────────────────────────┤
│            Footer (无)               │
└─────────────────────────────────────┘
```

**各区域说明**：
- **Header**：固定顶部，包含返回按钮、标题、收藏入口
- **每日一乐卡片**：首页顶部，高度约 200px，展示随机段子 + 操作按钮
- **段子列表**：虚拟列表区域，支持无限滚动
- **Footer**：无

### 4.2 页面详细设计

#### 页面1：首页（段子列表页）

**布局**：
- 顶部：每日一乐卡片（高度 220px）
- 下方：虚拟列表占满剩余空间

**每日一乐卡片区域**：
- 背景：渐变色或插画背景
- 标题："今日也要笑一笑" 或 emoji 😊
- 段子内容：大字号，居中显示，最多显示 3 行，超出省略
- 更新时间：小字显示 "更新时间: xxx"
- 操作按钮：
  - "换一个" 按钮（右侧，2秒冷却）
  - "查看更多 →" 按钮（底部，跳转到列表顶部）

**段子卡片**：
- 宽度：100% - 32px (左右各 16px 边距)
- 高度：自适应，最小 80px
- 圆角：16px
- 内容：
  - 段子正文（最多显示 2 行，超出省略）
  - 更新时间（小字）
  - 点赞数（假数据，随机显示）

**虚拟列表配置**：
- 预估行高：100px
-  overscan: 5
-  容器高度：calc(100vh - 220px - 头部高度)

#### 页面2：详情页

**布局**：
```
┌─────────────────────────────────────┐
│  ← 返回           段子乐      ❤️  📤 │
├─────────────────────────────────────┤
│                                     │
│      【原段子展示区】                │
│      ┌─────────────────────────┐   │
│      │                         │   │
│      │    段子内容全文         │   │
│      │    （完整显示）         │   │
│      │                         │   │
│      │    更新时间             │   │
│      └─────────────────────────┘   │
│                                     │
├─────────────────────────────────────┤
│                                     │
│      【AI 生成结果展示区】          │
│      （点击 AI 功能后显示结果）     │
│      ┌─────────────────────────┐   │
│      │                         │   │
│      │   图片/视频/文案预览    │   │
│      │                         │   │
│      └─────────────────────────┘   │
│                                     │
│      [复制文案]  [下载图片/视频]    │
│                                     │
├─────────────────────────────────────┤
│                                     │
│      【AI 功能按钮区】              │
│      横向滚动或网格布局             │
│      ┌────┐ ┌────┐ ┌────┐ ┌────┐ │
│      │续写│ │改写│ │吐槽│ │相似│ │
│      └────┘ └────┘ └────┘ └────┘ │
│      ┌────┐ ┌────┐                │
│      │生成图│ │朋友圈│               │
│      └────┘ └────┘                │
│                                     │
└─────────────────────────────────────┘
```

**交互细节**：
- 点击 AI 功能按钮 -> 显示 loading 状态 -> 生成完成后显示结果
- 生成图片/视频：点击后在大图区域展示，可缩放预览
- 朋友圈预览：点击"朋友圈"按钮后，在中间区域显示完整模拟朋友圈界面

#### 页面3：朋友圈预览弹窗/区域

**布局**（完整模拟朋友圈）：
```
┌─────────────────────────────────────┐
│  头像    昵称                        │
│          今天也要开心呀              │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  │       段子配图              │   │
│  │                             │   │
│  └─────────────────────────────┘   │
│          3分钟前                    │
│     ❤️ 12   💬 5   🔘 2           │
│  ─────────────────────────────     │
│  评论区（不可点击，仅展示）        │
│  小明：哈哈笑死我了                │
│  小红：太经典了                   │
└─────────────────────────────────────┘
```

**控件规范**：

**输入框**：
- 宽度：100% - 32px
- 高度：自适应
- 圆角：12px
- 边框：1px solid #e5e7eb
- 内边距：16px

**按钮**：
- 主要按钮：背景 #6366f1 (indigo-500)，白色文字，圆角 12px，height 44px
- 次要按钮：背景 #f3f4f6，灰色文字，圆角 12px，height 36px
- AI 功能按钮：56x56 或 64x64，正方形，圆角 16px，带图标 + 文字

**间距**：
- 卡片间距：16px
- 卡片内边距：16px
- 区块间距：24px

---

## 5. 智谱 AI 能力配置

### 5.1 使用的 AI 能力列表

| AI 能力 | 用途 | 使用场景 |
|---------|------|----------|
| GLM-4-Flash (文本生成) | AI 续写、改写、吐槽、推荐相似段子、生成朋友圈文案 | 用户点击对应 AI 功能按钮时 |
| CogView-3 (图像生成) | 生成段子配图、朋友圈配图 | 用户点击"生成图片"或"朋友圈"时 |

### 5.2 能力配置说明

**能力1：GLM-4-Flash 文本生成**
- **配置参数**：
  - model: glm-4-flash
  - temperature: 0.8 (稍微有创意)
  - max_tokens: 500
- **调用时机**：用户点击续写/改写/吐槽/相似推荐/朋友圈文案按钮
- **输入格式**：Prompt + 段子内容
- **输出格式**：JSON 包含生成的文本

**能力2：CogView-3 图像生成**
- **配置参数**：
  - model: cogview-3
  - size: 1024x1024 或 720x1280 (朋友圈竖版)
  - quality: standard
- **调用时机**：用户点击"生成图片"或"朋友圈"按钮
- **输入格式**：Prompt 描述图片内容（根据段子内容生成）
- **输出格式**：图片 URL 或 Base64

### 5.3 AI 功能 Prompt 设计

**AI 续写**：
```
请根据以下段子续写后续情节，要求幽默风趣，与原文风格一致：
{{段子内容}}
续写：
```

**AI 改写风格**：
```
请将以下段子改写成{{风格}}风格，要求保持原意但语言风格变化：
{{段子内容}}
改写：
```
可选风格：冷幽默、黑色幽默、沙雕风、文艺复兴、段子手风格

**AI 吐槽**：
```
请对以下段子进行毒舌点评/吐槽，要求幽默犀利，一针见血：
{{段子内容}}
点评：
```

**AI 推荐相似**：
```
请根据以下段子的风格，推荐3-5个相似风格的段子主题或关键词：
{{段子内容}}
推荐：
```

**生成图片**：
```
请为以下段子生成一张幽默的配图，风格可以是表情包风格或简约文字卡片风格：
{{段子内容}}
```

**朋友圈文案**：
```
请为以下段子生成一条适合发朋友圈的文案，要求有趣、吸引人点赞：
{{段子内容}}
文案：
```

---

## 6. 技术需求

### 6.1 技术要求
- **前端框架**：Next.js 15 + React 19 + TypeScript
- **UI 组件库**：Ant Design 5 + Tailwind CSS
- **虚拟列表**：@tanstack/react-virtual
- **状态管理**：React useState/useReducer
- **HTTP 客户端**：fetch
- **AI 集成**：智谱 AI Open API (glm-4-flash, cogview-3)
- **部署平台**：Vercel + GitHub Pages

### 6.2 性能要求
- 首页加载：< 1s
- 列表滚动：60fps 流畅
- AI 生成：显示 loading 状态，超时 30s
- 请求队列：每日一乐"换一个"间隔 2s

### 6.3 数据要求
- **段子数据**：调用 mxnzp API 获取
- **收藏存储**：localStorage，结构 `[{id, content, updateTime, collectTime}]`
- **AI 生成结果**：临时存储在组件状态，不持久化

---

## 7. 优先级规划

### 7.1 第一期（MVP）
- [x] 每日一乐卡片 + "换一个"功能
- [x] 段子列表（无限滚动，非虚拟列表）
- [x] 段子详情页展示
- [x] AI 续写段子
- [x] AI 改写风格
- [x] AI 点评/吐槽

### 7.2 第二期
- [ ] 虚拟列表优化性能
- [ ] AI 生成图片
- [ ] AI 推荐相似段子
- [ ] 收藏功能
- [ ] 朋友圈预览 + 一键生成

### 7.3 未来规划
- [ ] AI 生成小动画视频
- [ ] 用户登录云同步收藏
- [ ] 分享到其他平台（微信、微博、抖音）
- [ ] 社区功能：用户投稿段子

---

## 8. 参考产品

### 8.1 参考产品列表
- **段子乐 Android APP**：参考数据来源和段子展示方式
- **微信朋友圈**：参考朋友圈预览界面

### 8.2 差异化说明
- 本产品定位为"工具+内容消费"，不仅是看段子，还能生成素材分享
- AI 增强功能是核心差异化，主打"看完还能玩"
- 纯前端实现，无需后端服务器

---

## 9. 待补充事项

- [ ] 智谱 AI API Key 配置方式（环境变量或用户输入）
- [ ] 点赞数的生成逻辑（随机还是固定）
- [ ] 分享功能的具体实现（复制链接还是截图）
- [ ] 是否需要埋点/统计用户行为

---

## 附录：使用说明

1. **配置智谱 AI**：在环境变量或设置页面配置智谱 AI 的 API Key
2. **实现功能**：按照「功能需求」和「用户流程」部分实现功能
3. **设计界面**：按照「UI/UX 设计」部分实现界面布局和交互
4. **测试 AI 功能**：确保各 AI 功能按钮调用智谱 API 正常返回结果

---

## 接口参考

### mxnzp 段子 API

**随机获取段子列表**
```
GET https://www.mxnzp.com/api/jokes/list/random
?app_id=YOUR_APP_ID&app_secret=YOUR_APP_SECRET
```

**分页获取段子列表**
```
GET https://www.mxnzp.com/api/jokes/list
?page=1&app_id=YOUR_APP_ID&app_secret=YOUR_APP_SECRET
```

#### 随机获取段子返回值

```json
{
  "code": 1,
  "msg": "数据返回成功",
  "data": [
    {
      "content": "段子内容文本",
      "updateTime": "2018-04-30 13:45:44"
    }
  ]
}
```

**返回值说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| code | int | 1=成功，0=失败 |
| msg | string | 提示信息 |
| data | Array | 段子列表 |
| content | string | 段子内容 |
| updateTime | string | 更新时间，格式：yyyy-MM-dd HH:mm:ss |

#### 分页获取段子返回值

```json
{
  "code": 1,
  "msg": "数据返回成功",
  "data": {
    "page": 2,
    "totalCount": 9590,
    "totalPage": 959,
    "limit": 10,
    "list": [
      {
        "content": "段子内容文本",
        "updateTime": "2018-11-03 09:45:28"
      }
    ]
  }
}
```

**返回值说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| page | int | 当前页码 |
| totalCount | int | 总数量 |
| totalPage | int | 总页数 |
| limit | int | 每页数量 |
| list | Array | 每页数据列表 |
| content | string | 段子内容 |
| updateTime | string | 更新时间 |

### 智谱 AI API

**文本生成 (GLM-4-Flash)**
```
POST https://open.bigmodel.cn/api/paas/v4/chat/completions
Headers: Authorization: Bearer YOUR_API_KEY
Body: {
  "model": "glm-4-flash",
  "messages": [{"role": "user", "content": "prompt"}]
}
```

**图像生成 (CogView-3)**
```
POST https://open.bigmodel.cn/api/paas/v4/images/generations
Headers: Authorization: Bearer YOUR_API_KEY
Body: {
  "model": "cogview-3",
  "prompt": "描述",
  "size": "1024x1024"
}
```
