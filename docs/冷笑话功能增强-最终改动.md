# Punchliner 冷笑话功能增强 - 最终改动

## 一、需求实现

### 1. 首页布局
```
❄️ 今日冷笑话（暗调卡片）
✨ 今日也要笑一笑（亮调卡片）
🎭 更多段子
```

### 2. 冷笑话详情页
- URL使用Base64加密（与段子详情页一致）
- 亮色调风格句逻辑（按
- 断句末符号拆分）
- 两个按钮：生成配图 + 类似冷笑话
- 类似冷笑话直接在下方显示

### 3. 图片生成
- **使用智谱AI生成猫咪图片**
- 多宫格合成一张大图（纵向排列）
- 每个格子：
  - 黑色边框白色背景
  - 猫咪图片居中偏上
  - 黑色文字显示在下方
- 格子之间间隔10px
- 格子尺寸：340x380

---

## 二、文件改动

### 修改的文件

| 文件 | 改动 |
|------|------|
| `src/app/page.tsx` | URL使用Base64加密 |
| `src/app/cold-joke/[id]/page.tsx` | Base64解码 + 多宫格合成 + 智谱AI图片 |
| `src/lib/ai.ts` | 猫咪图片prompt |

### 新增的文件

| 文件 | 说明 |
|------|------|
| `public/cat1.png` | 猫咪图片1（备用） |
| `public/cat2.png` | 猫咪图片2（备用） |

---

## 三、技术方案

### 1. 图片生成流程
```
前端调用 /api/ai/image → 智谱AI生成图片 → 返回图片URL
                                       ↓
前端通过 /api/proxy/image 代理下载图片（Blob）
                                       ↓
使用 Canvas 合成多宫格图片
```

### 2. CORS问题解决
- 智谱AI返回的图片URL有CORS限制
- 使用 `fetch` + `Blob` + `URL.createObjectURL` 方式解决
- 在服务端通过 `/api/proxy/image` 代理下载

### 3. 本地猫咪图片（备用）
当AI图片生成失败时，使用本地静态图片：
```javascript
const catImages = [
  '/cat1.png',
  '/cat2.png',
]
```

---

## 四、测试要点

1. 冷笑话详情页URL是否为Base64加密格式
2. 点击生成配图后是否生成一张多宫格图片
3. 图片风格是否正确：黑色边框 + 猫咪 + 黑色文字
4. 宫格数量是否正确（根据句子数量）
5. CORS问题是否已解决（不再报跨域错误）
